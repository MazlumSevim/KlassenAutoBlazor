@page "/weather"
@using System.Globalization
@using KlasseAuto.Blazor.Data
@inject WeatherApiService WeatherService

<h3>Wetter</h3>

<div class="mb-3">
    <label for="cityInput">Stadt:</label>
    <input id="cityInput"
           class="form-control"
           style="max-width:250px; display:inline-block; margin-right:0.5rem;"
           @bind="_city" />

    <button type="button" class="btn btn-primary" @onclick="LoadWeather">
        Stadt hinzufügen
    </button>
</div>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">
        Fehler: @_error
    </div>
}

@if (_result is null && string.IsNullOrEmpty(_error))
{
    <p>Bitte gib eine Stadt ein (z. B. Berlin, Istanbul, London) und klicke auf „Laden“.</p>
}
else if (_result is not null)
{
    <h4>Aktuelles Wetter – @_result.City</h4>

    <p>
        @if (!string.IsNullOrWhiteSpace(_result.Current.Icon))
        {
            <img src="@GetIconUrl(_result.Current.Icon)"
                 alt="@_result.Current.Description"
                 style="width:80px;height:80px;margin-right:12px;image-rendering:auto;" />
        }

        <strong>@_result.Current.TemperatureC.ToString("0 ") °C</strong><br />
        @_result.Current.Description<br />
        Stand: @_result.Current.Time.ToString("dd.MM.yyyy HH:mm", CultureInfo.CurrentCulture)
    </p>

    <h4>Vorhersage (nächste Tage)</h4>

    <table class="table table-striped table-hover table-sm">
        <thead>
            <tr>
                <th>Datum</th>
                <th></th>
                <th>Temperatur</th>
                <th>Beschreibung</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var f in _result.Forecast)
            {
                <tr>
                    <td>@f.Date.ToString("ddd, dd.MM.yyyy", CultureInfo.CurrentCulture)</td>
                    <td class="text-center" style="vertical-align:middle;">
    @if (!string.IsNullOrWhiteSpace(f.Icon))
    {
        <img src="@GetIconUrl(f.Icon)"
             alt="@f.Description"
             style="width:60px;height:60px;image-rendering:auto;" />
    }
</td>

                    <td>@f.TemperatureC.ToString("0 ") °C</td>
                    <td>@f.Description</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private string _city = string.Empty;
    private bool _isLoading = false;
    private string? _error;
    private CityWeatherResult? _result;   // <-- WICHTIG! Dadurch ist _result NICHT MEHR ROT

    private async Task LoadWeather()
    {
        _error = null;
        _isLoading = true;
        _result = null;
        StateHasChanged();

        try
        {
            var res = await WeatherService.GetWeatherForCityAsync(_city);

            if (res == null)
                _error = "Keine Daten gefunden. Stadt korrekt?";
            else
                _result = res;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }

        _isLoading = false;
        StateHasChanged();
    }

    private string GetIconUrl(string iconCode)
    {
        if (string.IsNullOrWhiteSpace(iconCode))
            return "";

        return $"https://openweathermap.org/img/wn/{iconCode}@2x.png";
    }
}
