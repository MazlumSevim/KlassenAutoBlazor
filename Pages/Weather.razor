@page "/weather"
@using System.Globalization
@using KlasseAuto.Blazor.Data
@inject WeatherApiService WeatherService

<h3>Wetter – mehrere Städte</h3>

<div class="mb-3">
    <label for="cityInput">Neue Stadt:</label>
    <input id="cityInput"
           class="form-control"
           style="max-width:250px; display:inline-block; margin-right:0.5rem;"
           @bind="_newCity" />

    <button type="button" class="btn btn-primary" @onclick="AddCity">
        Stadt hinzufügen
    </button>
</div>

@if (!string.IsNullOrEmpty(_globalError))
{
    <div class="alert alert-danger">
        Fehler: @_globalError
    </div>
}

@if (!_cities.Any())
{
    <p>Noch keine Städte hinzugefügt. Gib oben eine Stadt ein (z. B. Berlin, Istanbul, London) und klick auf „Stadt hinzufügen“.</p>
}
else
{
    @foreach (var city in _cities)
    {
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>@city.Name</strong>

                <div>
                    <button type="button"
                            class="btn btn-sm btn-secondary"
                            @onclick="() => ReloadCity(city)">
                        Aktualisieren
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-danger"
                            style="margin-left:0.5rem;"
                            @onclick="() => RemoveCity(city)">
                        Löschen
                    </button>
                </div>
            </div>

            <div class="card-body">
                @if (!string.IsNullOrEmpty(city.Error))
                {
                    <div class="alert alert-danger">
                        Fehler für @city.Name: @city.Error
                    </div>
                }
                else if (city.IsLoading)
                {
                    <p>Wetter für @city.Name wird geladen…</p>
                }
                else if (city.Data is null)
                {
                    <p>Keine Daten für @city.Name.</p>
                }
                else
                {
                    <h5>Aktuelles Wetter</h5>
                    <p>
                        @if (!string.IsNullOrWhiteSpace(city.Data.Current.Icon))
                        {
                            <img src="@GetIconUrl(city.Data.Current.Icon)"
                                 alt="@city.Data.Current.Description"
                                 style="width:80px;height:80px;margin-right:12px;image-rendering:auto;" />
                        }

                        <strong>@ToIntTemp(city.Data.Current.TemperatureC) °C</strong><br />
                        @city.Data.Current.Description<br />
                        Stand: @city.Data.Current.Time.ToString("dd.MM.yyyy HH:mm", CultureInfo.CurrentCulture)
                    </p>

                    <h5>Vorhersage (nächste Tage)</h5>

                    @if (city.Data.Forecast is null || !city.Data.Forecast.Any())
                    {
                        <p>Keine Vorhersage verfügbar.</p>
                    }
                    else
                    {
                        <table class="table table-hover table-sm weather-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th></th>
                                    <th>Temperatur</th>
                                    <th>Beschreibung</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var f in city.Data.Forecast)
                                {
                                    <tr>
                                        <td>@f.Date.ToString("ddd, dd.MM.yyyy", CultureInfo.CurrentCulture)</td>
                                        <td class="text-center">
                                            @if (!string.IsNullOrWhiteSpace(f.Icon))
                                            {
                                                <img src="@GetIconUrl(f.Icon)"
                                                     alt="@f.Description"
                                                     style="width:60px;height:60px;image-rendering:auto;" />
                                            }
                                        </td>
                                        <td>@ToIntTemp(f.TemperatureC) °C</td>
                                        <td>@f.Description</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                }
            </div>
        </div>
    }
}

@code {
    private string _newCity = string.Empty;
    private string? _globalError;
    private readonly List<CityWeatherViewModel> _cities = new();

    protected override async Task OnInitializedAsync()
    {
        // Optional: Standard-Stadt beim Start laden
        // await AddCityInternal("Berlin");
    }

    private async Task AddCity()
    {
        _globalError = null;

        var cityName = _newCity?.Trim();
        if (string.IsNullOrWhiteSpace(cityName))
            return;

        _newCity = string.Empty;

        await AddCityInternal(cityName);
    }

    private async Task AddCityInternal(string cityName)
    {
        // Verhindern, dass dieselbe Stadt mehrfach hinzugefügt wird
        if (_cities.Any(c => string.Equals(c.Name, cityName, StringComparison.OrdinalIgnoreCase)))
            return;

        var vm = new CityWeatherViewModel(cityName);
        _cities.Add(vm);

        await LoadDataForCity(vm);
    }

    private async Task LoadDataForCity(CityWeatherViewModel city)
    {
        city.Error = null;
        city.IsLoading = true;
        StateHasChanged();

        try
        {
            var result = await WeatherService.GetWeatherForCityAsync(city.Name);
            if (result is null)
            {
                city.Error = "Keine Daten gefunden. Stadtname korrekt?";
                city.Data = null;
            }
            else
            {
                city.Data = result;
            }
        }
        catch (Exception ex)
        {
            city.Error = ex.Message;
            city.Data = null;
        }
        finally
        {
            city.IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ReloadCity(CityWeatherViewModel city)
    {
        await LoadDataForCity(city);
    }

    private void RemoveCity(CityWeatherViewModel city)
    {
        _cities.Remove(city);
    }

    private string GetIconUrl(string? iconCode)
    {
        if (string.IsNullOrWhiteSpace(iconCode))
            return "";

        return $"https://openweathermap.org/img/wn/{iconCode}@2x.png";
    }

    private int ToIntTemp(double tempC)
    {
        return (int)Math.Round(tempC);
    }

    private class CityWeatherViewModel
    {
        public string Name { get; }
        public bool IsLoading { get; set; }
        public string? Error { get; set; }
        public CityWeatherResult? Data { get; set; }

        public CityWeatherViewModel(string name)
        {
            Name = name;
        }
    }
}
