@page "/fahrzeug"
@using KlasseAuto.Blazor.Models
@using System.IO
@using System.Text
@using Microsoft.AspNetCore.Components.Forms

<h3>Fahrzeug / Fahrer / Kunde</h3>

<EditForm Model="_model" OnValidSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

 



    <fieldset style="margin-bottom:1rem;">
        <legend>Fahrer</legend>

        <div>
            <label style="display:inline-block; width:120px;">Vorname:</label>
            <InputText @bind-Value="_model.FahrerVorname" />
        </div>

        <div>
            <label style="display:inline-block; width:120px;">Nachname:</label>
            <InputText @bind-Value="_model.FahrerNachname" />
        </div>

        <div>
            <label>
                <InputCheckbox @bind-Value="_model.HatFuehrerschein" />
                Hat Führerschein
            </label>
        </div>
    </fieldset>

    <fieldset style="margin-bottom:1rem;">
        <legend>Kunde</legend>

        <div>
            <label style="display:inline-block; width:120px;">Vorname:</label>
            <InputText @bind-Value="_model.KundeVorname" />
        </div>

        <div>
            <label style="display:inline-block; width:120px;">Nachname:</label>
            <InputText @bind-Value="_model.KundeNachname" />
        </div>
    </fieldset>

    <fieldset style="margin-bottom:1rem;">
        <legend>Auto</legend>

        <div>
            <label style="display:inline-block; width:120px;">Marke:</label>
            <InputText @bind-Value="_model.AutoMarke" />
        </div>

        <div>
            <label style="display:inline-block; width:120px;">Besitzer (optional):</label>
            <InputText @bind-Value="_model.Besitzer" />
        </div>
    </fieldset>

    <button type="submit">Daten hinzufügen</button>
    <button type="button" style="margin-left:1rem;" @onclick="ClearForm">Formular leeren</button>
</EditForm>

@if (!string.IsNullOrWhiteSpace(_lastMessage))
{
    <p style="margin-top:0.5rem;">@_lastMessage</p>
}

<hr />

<h4>Gespeicherte Fahrzeuge (@_fahrzeuge.Count)</h4>

@if (_fahrzeuge.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Marke)))" style="cursor:pointer;">
                    Marke @SortIndicator(nameof(ViewModel.Marke))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Fahrer)))" style="cursor:pointer;">
                    Fahrer @SortIndicator(nameof(ViewModel.Fahrer))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Kunde)))" style="cursor:pointer;">
                    Kunde @SortIndicator(nameof(ViewModel.Kunde))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Besitzer)))" style="cursor:pointer;">
                    Besitzer @SortIndicator(nameof(ViewModel.Besitzer))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.FuehrerscheinInfo)))" style="cursor:pointer;">
                    Führerschein @SortIndicator(nameof(ViewModel.FuehrerscheinInfo))
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var f in SortedFahrzeuge)
            {
                <tr>
                    <td>@f.Marke</td>
                    <td>@f.Fahrer</td>
                    <td>@f.Kunde</td>
                    <td>@f.Besitzer</td>
                    <td>@f.FuehrerscheinInfo</td>
                </tr>
            }
        </tbody>
    </table>

    <hr />

<h4>CSV-Import / Export</h4>

<div class="mb-2">
    <button type="button" class="btn btn-secondary btn-sm" @onclick="GenerateCsv">
        CSV für Export vorbereiten
    </button>

    @if (!string.IsNullOrEmpty(_csvDownloadUrl))
    {
        <a class="btn btn-success btn-sm ms-2"
           href="@_csvDownloadUrl"
           download="fahrzeuge.csv">
            CSV herunterladen
        </a>
    }
</div>

<div class="mb-2">
    <label>CSV importieren:</label>
    <InputFile OnChange="OnCsvUpload" accept=".csv,text/csv" />
</div>

@if (!string.IsNullOrEmpty(_lastCsvMessage))
{
    <p>@_lastCsvMessage</p>
}


    <button type="button" @onclick="ClearList">Liste löschen</button>
}
else
{
    <p>Noch keine Fahrzeuge gespeichert.</p>

    <hr />

<h4>CSV-Import / Export</h4>

<div class="mb-2">
    <button type="button" class="btn btn-secondary btn-sm" @onclick="GenerateCsv">
        CSV für Export vorbereiten
    </button>

    @if (!string.IsNullOrEmpty(_csvDownloadUrl))
    {
        <a class="btn btn-success btn-sm ms-2"
           href="@_csvDownloadUrl"
           download="fahrzeuge.csv">
            CSV herunterladen
        </a>
    }
</div>

<div class="mb-2">
    <label>CSV importieren:</label>
    <InputFile OnChange="OnCsvUpload" accept=".csv,text/csv" />
</div>

@if (!string.IsNullOrEmpty(_lastCsvMessage))
{
    <p>@_lastCsvMessage</p>
}

}

@code {
      private string? _csvDownloadUrl;
    private string? _lastCsvMessage;

    private void GenerateCsv()
{
    if (!_fahrzeuge.Any())
    {
        _lastCsvMessage = "Keine Fahrzeuge zum Export.";
        _csvDownloadUrl = null;
        return;
    }

    var sb = new StringBuilder();

    // Kopfzeile
    sb.AppendLine("Marke;Fahrer;Kunde;Besitzer;Fuehrerschein");

    foreach (var f in _fahrzeuge)
    {
        // Hier gehen wir davon aus, dass dein ViewModel diese Properties hat:
        // Marke, Fahrer, Kunde, Besitzer, FuehrerscheinInfo
        sb.AppendLine($"{f.Marke};{f.Fahrer};{f.Kunde};{f.Besitzer};{f.FuehrerscheinInfo}");
    }

    var csv = sb.ToString();
    var bytes = Encoding.UTF8.GetBytes(csv);
    var base64 = Convert.ToBase64String(bytes);

    _csvDownloadUrl = $"data:text/csv;base64,{base64}";
    _lastCsvMessage = $"CSV mit {_fahrzeuge.Count} Einträgen vorbereitet.";
}

private async Task OnCsvUpload(InputFileChangeEventArgs e)
{
    var file = e.File;
    if (file is null)
    {
        _lastCsvMessage = "Keine Datei ausgewählt.";
        return;
    }

    try
    {
        using var stream = file.OpenReadStream(1024 * 1024); // max. 1 MB
        using var reader = new StreamReader(stream, Encoding.UTF8);
        var content = await reader.ReadToEndAsync();

        var lines = content
            .Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(l => l.Trim('\r'))   // Windows-Zeilenende säubern
            .ToArray();

        if (lines.Length <= 1)
        {
            _lastCsvMessage = "CSV enthält keine Daten.";
            return;
        }

        // Alte Liste leeren
        _fahrzeuge.Clear();

        // Erste Zeile = Header, ab Zeile 1 einlesen
        for (int i = 1; i < lines.Length; i++)
        {
            var line = lines[i];
            if (string.IsNullOrWhiteSpace(line))
                continue;

            var cols = line.Split(';');
            if (cols.Length < 5)
                continue; // ungültige Zeile überspringen

            var vm = new ViewModel
            {
                Marke = cols[0],
                Fahrer = cols[1],
                Kunde = cols[2],
                Besitzer = cols[3],
                FuehrerscheinInfo = cols[4]
            };

            _fahrzeuge.Add(vm);
        }

        _lastCsvMessage = $"CSV importiert: {_fahrzeuge.Count} Fahrzeuge geladen.";
    }
    catch (Exception ex)
    {
        _lastCsvMessage = $"Fehler beim Import: {ex.Message}";
    }
}
   
   
   
   
    // Formular-Daten (nur für die Eingabe)
    private class FahrzeugFormModel
    {
        public string FahrerVorname { get; set; } = "";
        public string FahrerNachname { get; set; } = "";
        public bool HatFuehrerschein { get; set; }

        public string KundeVorname { get; set; } = "";
        public string KundeNachname { get; set; } = "";

        public string AutoMarke { get; set; } = "";
        public string Besitzer { get; set; } = "";
    }

    private FahrzeugFormModel _model = new();
    private string? _lastMessage;

    // Liste aller Fahrzeuge (ViewModels)
    private List<ViewModel> _fahrzeuge = new();

    // Sortierzustand
    private string _sortColumn = nameof(ViewModel.Marke);
    private bool _sortAscending = true;

    private IEnumerable<ViewModel> SortedFahrzeuge =>
        _sortColumn switch
        {
            nameof(ViewModel.Marke) =>
                _sortAscending ? _fahrzeuge.OrderBy(f => f.Marke)
                               : _fahrzeuge.OrderByDescending(f => f.Marke),

            nameof(ViewModel.Fahrer) =>
                _sortAscending ? _fahrzeuge.OrderBy(f => f.Fahrer)
                               : _fahrzeuge.OrderByDescending(f => f.Fahrer),

            nameof(ViewModel.Kunde) =>
                _sortAscending ? _fahrzeuge.OrderBy(f => f.Kunde)
                               : _fahrzeuge.OrderByDescending(f => f.Kunde),

            nameof(ViewModel.Besitzer) =>
                _sortAscending ? _fahrzeuge.OrderBy(f => f.Besitzer)
                               : _fahrzeuge.OrderByDescending(f => f.Besitzer),

            nameof(ViewModel.FuehrerscheinInfo) =>
                _sortAscending ? _fahrzeuge.OrderBy(f => f.FuehrerscheinInfo)
                               : _fahrzeuge.OrderByDescending(f => f.FuehrerscheinInfo),

            _ => _fahrzeuge
        };


        

    private void SortBy(string column)
    {
        if (_sortColumn == column)
        {
            _sortAscending = !_sortAscending;
        }
        else
        {
            _sortColumn = column;
            _sortAscending = true;
        }
    }

    private string SortIndicator(string column)
    {
        if (_sortColumn != column) return "";
        return _sortAscending ? "▲" : "▼";
    }

    private void OnSubmit()
    {
        if (string.IsNullOrWhiteSpace(_model.FahrerVorname) ||
            string.IsNullOrWhiteSpace(_model.FahrerNachname) ||
            string.IsNullOrWhiteSpace(_model.AutoMarke))
        {
            _lastMessage = "Bitte mindestens Fahrer (Vor- und Nachname) und Auto-Marke eingeben.";
            return;
        }

        var besitzerName = string.IsNullOrWhiteSpace(_model.Besitzer)
            ? $"{_model.FahrerVorname} {_model.FahrerNachname}"
            : _model.Besitzer;

        // Deine Domänen-Klassen nutzen
        var fahrer = new Fahrer(_model.FahrerVorname,
                                _model.FahrerNachname,
                                _model.HatFuehrerschein);

        var kunde = new Kunde(_model.KundeVorname,
                              _model.KundeNachname);

        var auto = new Auto(_model.AutoMarke,
                            $"{fahrer.Vorname} {fahrer.Nachname}",
                            besitzerName);

        var vm = new ViewModel
        {
            Marke             = auto.autoMarke,
            Fahrer            = $"{fahrer.Vorname} {fahrer.Nachname}",
            Besitzer          = auto.besitzer,
            FuehrerscheinInfo = fahrer.HatFuehrerschein ? "Ja" : "Nein",
            Kunde             = $"{kunde.Vorname} {kunde.Nachname}"
        };

        _fahrzeuge.Add(vm);

        _lastMessage = "Fahrzeug hinzugefügt.";
    }

    private void ClearForm()
    {
        _model = new FahrzeugFormModel();
        _lastMessage = null;
    }

    private void ClearList()
    {
        _fahrzeuge.Clear();
        _lastMessage = "Liste geleert.";
    }
}
