@page "/fahrzeug"
@* Fahrzeugseite.
   - Formular zur Eingabe von Fahrzeug- und Besitzer-Daten.
   - Die Eingaben werden an das Auto-Modell und ggf. den Controller gebunden.
   - Unten werden die erfassten Daten wieder angezeigt. *@
@using KlasseAuto.Blazor.Models
@using System.IO
@using System.Text
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using System.Linq
@using Microsoft.AspNetCore.Components
@inject KlasseAuto.Blazor.Data.SupabaseAutoService SupaService



<div class="fahrzeug-page">

<section class="card-box">
<h3>Fahrzeug / Fahrer / Kunde</h3>


<EditForm Model="_model" OnValidSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

 



        <div class="fahrzeug-form-grid">

       <fieldset style="margin-bottom:1rem;">
    <legend>Fahrer</legend>

    <div>
        <label style="display:inline-block; width:120px;">Vorname:</label>
        <input class="form-Control" 
                @bind="_model.FahrerVorname"
                @ref="_fahrerVornameRef"
                @onkeydown="@(e => HandleEnter(e, _fahrerNachnameRef))"/>
    </div>

    <div>
        <label style="display:inline-block; width:120px;">Nachname:</label>
        <input class="form-Control" 
                @bind="_model.FahrerNachname"
                @ref="_fahrerNachnameRef"
                @onkeydown="@(e => HandleEnter(e, _kundeVornameRef))" />
    </div>

    <div>
        <label>
            <input type="checkbox" 
                    @bind="_model.HatFuehrerschein" />
            Hat Führerschein
        </label>
    </div>
</fieldset>

<fieldset style="margin-bottom:1rem;">
    <legend>Kunde</legend>

    <div>
        <label style="display:inline-block; width:120px;">Vorname:</label>
        <input class="form-Control" 
                @bind="_model.KundeVorname"
                @ref="_kundeVornameRef"
                @onkeydown="@(e => HandleEnter(e, _kundeNachnameRef))" />
    </div>

    <div>
        <label style="display:inline-block; width:120px;">Nachname:</label>
        <input class="form-Control" 
                @bind="_model.KundeNachname"
                @ref="_kundeNachnameRef"
                @onkeydown="@(e => HandleEnter(e, _autoMarkeRef))"/>
    </div>
</fieldset>

<fieldset style="margin-bottom:1rem;">
    <legend>Auto</legend>

    <div>
        <label style="display:inline-block; width:120px;">Marke:</label>
        <input class="form-Control" 
                @bind="_model.AutoMarke"
                @ref="_autoMarkeRef"
                @onkeydown="@(e => HandleEnter(e, _besitzerRef))"/>
    </div>

    <div>
        <label style="display:inline-block; width:120px;">Besitzer (optional):</label>
        <input class="form-Control" 
                @bind="_model.Besitzer"
                @ref="_besitzerRef"/>
                @* HIER KEIN HandleEnter -> Enter schickt das Formular ab *@
    </div>
</fieldset>

    </div>


        <div class="fahrzeug-buttons">
        <button type="submit" class="btn btn-primary">
            Daten hinzufügen
        </button>
        <button type="button" class="btn btn-secondary" @onclick="ClearForm">
            Formular leeren
        </button>
    </div>

</EditForm>

@if (!string.IsNullOrWhiteSpace(_lastMessage))
{
    <p style="margin-top:0.5rem;">@_lastMessage</p>
}
</section>

<hr />
<section>
<h4>Gespeicherte Fahrzeuge (@_fahrzeuge.Count)</h4>
@if (_fahrzeuge.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Marke)))" style="cursor:pointer;">
                    Marke @SortIndicator(nameof(ViewModel.Marke))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Fahrer)))" style="cursor:pointer;">
                    Fahrer @SortIndicator(nameof(ViewModel.Fahrer))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Kunde)))" style="cursor:pointer;">
                    Kunde @SortIndicator(nameof(ViewModel.Kunde))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.Besitzer)))" style="cursor:pointer;">
                    Besitzer @SortIndicator(nameof(ViewModel.Besitzer))
                </th>
                <th @onclick="@(() => SortBy(nameof(ViewModel.FuehrerscheinInfo)))" style="cursor:pointer;">
                    Führerschein @SortIndicator(nameof(ViewModel.FuehrerscheinInfo))
                </th>
            </tr>
        </thead>
        
        <tbody>
            @foreach (var f in SortedFahrzeuge)
            {
                <tr>
                    <td>@f.Marke</td>
                    <td>@f.Fahrer</td>
                    <td>@f.Kunde</td>
                    <td>@f.Besitzer</td>
                    <td>@f.FuehrerscheinInfo</td>
                </tr>
            }
        </tbody>
    </table>
    <hr />
<h4>CSV-Import / Export</h4>

<div class="mb-2">
    <button type="button" class="btn btn-secondary btn-sm" @onclick="GenerateCsv">
        CSV für Export vorbereiten
    </button>

    @if (!string.IsNullOrEmpty(_csvDownloadUrl))
    {
        <a class="btn btn-success btn-sm ms-2"
           href="@_csvDownloadUrl"
           download="fahrzeuge.csv">
            CSV herunterladen
        </a>
    }
</div>

<div class="mb-2">
    <label>CSV importieren:</label>
    <InputFile OnChange="OnCsvUpload" accept=".csv,text/csv" />
</div>

@if (!string.IsNullOrEmpty(_lastCsvMessage))
{
    <p>@_lastCsvMessage</p>
}


    <button type="button" @onclick="ClearList">Liste löschen</button>
}
else
{
    <p>Noch keine Fahrzeuge gespeichert.</p>
    <hr />


<h4>CSV-Import / Export</h4>


<div class="mb-2">
    <button type="button" class="btn btn-secondary btn-sm" @onclick="GenerateCsv">
        CSV für Export vorbereiten
    </button>

    @if (!string.IsNullOrEmpty(_csvDownloadUrl))
    {
        <a class="btn btn-success btn-sm ms-2"
           href="@_csvDownloadUrl"
           download="fahrzeuge.csv">
            CSV herunterladen
        </a>
    }
</div>

<div class="mb-2">
    <label>CSV importieren:</label>
    <InputFile OnChange="OnCsvUpload" accept=".csv,text/csv" />
</div>

@if (!string.IsNullOrEmpty(_lastCsvMessage))
{
    <p>@_lastCsvMessage</p>
}

}
</section>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Marke</th>
            <th>Fahrer</th>
            <th>Besitzer</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var a in autos)
        {
            <tr>
                <td>@a.autoMarke</td>
                <td>@a.fahrer</td>
                <td>@a.besitzer</td>
            </tr>
        }
    </tbody>
</table>



@code {

    // Referenzen auf die Eingabefelder
private ElementReference _fahrerVornameRef;
private ElementReference _fahrerNachnameRef;
private ElementReference _kundeVornameRef;
private ElementReference _kundeNachnameRef;
private ElementReference _autoMarkeRef;
private ElementReference _besitzerRef;

 // Autos, die in Supabase gespeichert sind
private List<Auto> autos = new List<Auto>();

protected override async Task OnInitializedAsync()
{
    // Beim Laden der Seite alle Autos aus Supabase holen
    autos = await SupaService.GetAutosAsync();
}


private void  HandleEnter(KeyboardEventArgs e, ElementReference nextRef)
{
    if (e.Key == "Enter")
    {
        _= nextRef.FocusAsync();
    }
}

    private string? _csvDownloadUrl;
    private string? _lastCsvMessage;

    private void GenerateCsv()
{
    if (!_fahrzeuge.Any())
    {
        _lastCsvMessage = "Keine Fahrzeuge zum Export.";
        _csvDownloadUrl = null;
        return;
    }

    var sb = new StringBuilder();

    // Kopfzeile
    sb.AppendLine("Marke;Fahrer;Kunde;Besitzer;Fuehrerschein");

    foreach (var f in _fahrzeuge)
    {
        // Hier gehen wir davon aus, dass dein ViewModel diese Properties hat:
        // Marke, Fahrer, Kunde, Besitzer, FuehrerscheinInfo
        sb.AppendLine($"{f.Marke};{f.Fahrer};{f.Kunde};{f.Besitzer};{f.FuehrerscheinInfo}");
    }

    var csv = sb.ToString();
    var bytes = Encoding.UTF8.GetBytes(csv);
    var base64 = Convert.ToBase64String(bytes);

    _csvDownloadUrl = $"data:text/csv;base64,{base64}";
    _lastCsvMessage = $"CSV mit {_fahrzeuge.Count} Einträgen vorbereitet.";
}

private async Task OnCsvUpload(InputFileChangeEventArgs e)
{
    var file = e.File;
    if (file is null)
    {
        _lastCsvMessage = "Keine Datei ausgewählt.";
        return;
    }

    try
    {
        using var stream = file.OpenReadStream(1024 * 1024); // max. 1 MB
        using var reader = new StreamReader(stream, Encoding.UTF8);
        var content = await reader.ReadToEndAsync();

        var lines = content
            .Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(l => l.Trim('\r'))   // Windows-Zeilenende säubern
            .ToArray();

        if (lines.Length <= 1)
        {
            _lastCsvMessage = "CSV enthält keine Daten.";
            return;
        }

        // Alte Liste leeren
        _fahrzeuge.Clear();

        // Erste Zeile = Header, ab Zeile 1 einlesen
        for (int i = 1; i < lines.Length; i++)
        {
            var line = lines[i];
            if (string.IsNullOrWhiteSpace(line))
                continue;

            var cols = line.Split(';');
            if (cols.Length < 5)
                continue; // ungültige Zeile überspringen

            var vm = new ViewModel
            {
                Marke = cols[0],
                Fahrer = cols[1],
                Kunde = cols[2],
                Besitzer = cols[3],
                FuehrerscheinInfo = cols[4]
            };

            _fahrzeuge.Add(vm);
        }

        _lastCsvMessage = $"CSV importiert: {_fahrzeuge.Count} Fahrzeuge geladen.";
    }
    catch (Exception ex)
    {
        _lastCsvMessage = $"Fehler beim Import: {ex.Message}";
    }
}
   
   
   
   
    // Formular-Daten (nur für die Eingabe)
    private class FahrzeugFormModel
    {
        public string FahrerVorname { get; set; } = "";
        public string FahrerNachname { get; set; } = "";
        public bool HatFuehrerschein { get; set; }

        public string KundeVorname { get; set; } = "";
        public string KundeNachname { get; set; } = "";

        public string AutoMarke { get; set; } = "";
        public string Besitzer { get; set; } = "";
    }

    private FahrzeugFormModel _model = new();
    private string? _lastMessage;

    // Liste aller Fahrzeuge (ViewModels)
    private List<ViewModel> _fahrzeuge = new();

    // Sortierzustand
    private string _sortColumn = nameof(ViewModel.Marke);
private bool _sortAscending = true;

private void SortBy(string column)
{
    if (_sortColumn == column)
    {
        // Gleiche Spalte -> Richtung umdrehen
        _sortAscending = !_sortAscending;
    }
    else
    {
        // Neue Spalte -> aufsteigend starten
        _sortColumn = column;
        _sortAscending = true;
    }
}

private IEnumerable<ViewModel> SortedFahrzeuge =>
    _sortColumn switch
    {
        nameof(ViewModel.Marke)           => SortByKey(_fahrzeuge, f => f.Marke),
        nameof(ViewModel.Fahrer)          => SortByKey(_fahrzeuge, f => f.Fahrer),
        nameof(ViewModel.Kunde)           => SortByKey(_fahrzeuge, f => f.Kunde),
        nameof(ViewModel.Besitzer)        => SortByKey(_fahrzeuge, f => f.Besitzer),
        nameof(ViewModel.FuehrerscheinInfo) => SortByKey(_fahrzeuge, f => f.FuehrerscheinInfo),
        _                                  => _fahrzeuge
    };

private IEnumerable<ViewModel> SortByKey<TKey>(IEnumerable<ViewModel> source, Func<ViewModel, TKey> keySelector)
{
    return _sortAscending
        ? source.OrderBy(keySelector)
        : source.OrderByDescending(keySelector);
}

private MarkupString SortIndicator(string column)
{
    if (_sortColumn != column)
        return (MarkupString)string.Empty;

    var symbol = _sortAscending ? "▲" : "▼";
    return (MarkupString)$" {symbol}";
}

   private async Task OnSubmit()
{
    if (string.IsNullOrWhiteSpace(_model.FahrerVorname) ||
        string.IsNullOrWhiteSpace(_model.FahrerNachname) ||
        string.IsNullOrWhiteSpace(_model.AutoMarke))
    {
        _lastMessage = "Bitte mindestens Fahrer (Vor- und Nachname) und Auto-Marke eingeben.";
        return;
    }

    var besitzerName = string.IsNullOrWhiteSpace(_model.Besitzer)
        ? $"{_model.FahrerVorname} {_model.FahrerNachname}"
        : _model.Besitzer;

    // Deine Domänen-Klassen nutzen
    var fahrer = new Fahrer(_model.FahrerVorname,
                            _model.FahrerNachname,
                            _model.HatFuehrerschein);

    var kunde = new Kunde(_model.KundeVorname,
                          _model.KundeNachname);

    // Auto-Objekt, das zu Supabase geschickt wird
    var autoEntity = new Auto(_model.AutoMarke,
                              $"{fahrer.Vorname} {fahrer.Nachname}",
                              besitzerName);

    // ViewModel für deine Tabelle im UI
    var vm = new ViewModel
    {
        Marke             = autoEntity.autoMarke,
        Fahrer            = $"{fahrer.Vorname} {fahrer.Nachname}",
        Besitzer          = autoEntity.besitzer,
        FuehrerscheinInfo = fahrer.HatFuehrerschein ? "Ja" : "Nein",
        Kunde             = $"{kunde.Vorname} {kunde.Nachname}"
    };

    _fahrzeuge.Add(vm);

    // HIER: In Supabase speichern
    var saved = await SupaService.AddAutoAsync(autoEntity);
    if (saved != null)
    {
        // auch in der Supabase-Liste anzeigen
        autos.Add(saved);
        _lastMessage = "Fahrzeug hinzugefügt und in Supabase gespeichert.";
    }
    else
    {
        _lastMessage = "Fahrzeug lokal hinzugefügt, aber Speichern in Supabase ist fehlgeschlagen.";
    }
}

    private void ClearForm()
    {
        _model = new FahrzeugFormModel();
        _lastMessage = null;
    }

    private void ClearList()
    {
        _fahrzeuge.Clear();
        _lastMessage = "Liste geleert.";
    }
}